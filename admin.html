<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Phone Guard — Admin Panel</title>
  <style>
    :root{
      --bg:#040612;
      --glass: rgba(8, 12, 22, .65);
      --stroke: rgba(0,255,160,.22);
      --text:#e9fff7;
      --muted:#93cdbb;
      --neon:#00ffa0;
      --neon2:#00d4ff;
      --violet:#b06cff;
      --danger:#ff4d6d;
      --shadow: 0 0 60px rgba(0,255,160,.14), 0 0 90px rgba(0,212,255,.08), inset 0 0 90px rgba(0,40,20,.26);
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; padding:18px 14px 44px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 20% -10%, rgba(0,255,160,.22), transparent 55%),
        radial-gradient(750px 520px at 120% 20%, rgba(0,212,255,.20), transparent 55%),
        radial-gradient(800px 560px at 50% 120%, rgba(176,108,255,.12), transparent 58%),
        var(--bg);
      overflow-x:hidden;
    }
    .bgfx{position:fixed; inset:0; pointer-events:none; z-index:0; overflow:hidden;}
    .grid{
      position:absolute; inset:-30%;
      background:
        linear-gradient(to right, rgba(0,212,255,.10) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(0,255,160,.08) 1px, transparent 1px);
      background-size: 66px 66px;
      transform: rotate(-10deg);
      opacity:.42;
      animation: drift 11s linear infinite;
      filter: blur(.15px);
    }
    @keyframes drift{0%{transform:translate3d(0,0,0) rotate(-10deg)}100%{transform:translate3d(-66px,-66px,0) rotate(-10deg)}}
    .orb{position:absolute; width:560px; height:560px; border-radius:50%; filter: blur(75px); opacity:.55;}
    .orb1{background:rgba(0,212,255,.60); top:-220px; left:-240px; animation: float1 9s ease-in-out infinite}
    .orb2{background:rgba(0,255,160,.55); bottom:-260px; right:-260px; animation: float2 11s ease-in-out infinite}
    .orb3{background:rgba(176,108,255,.45); top:42%; left:-300px; animation: float3 13s ease-in-out infinite}
    @keyframes float1{50%{transform:translate(50px, 40px)}}
    @keyframes float2{50%{transform:translate(-55px, -40px)}}
    @keyframes float3{50%{transform:translate(70px, -30px)}}
    .scan{
      position:fixed; inset:0; pointer-events:none; z-index:1;
      background: repeating-linear-gradient(to bottom, rgba(0,255,160,.06) 0px, rgba(0,255,160,.06) 1px, transparent 2px, transparent 8px);
      mix-blend-mode: screen;
      animation:flicker 3.2s linear infinite;
      opacity:.16;
    }
    @keyframes flicker{50%{opacity:.11}}

    .wrap{max-width:860px;margin:0 auto; position:relative; z-index:2}

    .top{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:12px}
    .brand{display:flex;align-items:center;gap:10px;min-width:0}
    .logo{
      width:46px;height:46px;border-radius:16px;display:grid;place-items:center;font-weight:900;
      color:#021018;
      background: linear-gradient(135deg, rgba(0,255,160,.95), rgba(0,212,255,.88), rgba(176,108,255,.75));
      box-shadow: 0 12px 40px rgba(0,255,160,.22);
      position:relative; overflow:hidden; flex:0 0 auto;
    }
    .logo:after{
      content:""; position:absolute; inset:-50%;
      background: linear-gradient(120deg, transparent, rgba(255,255,255,.45), transparent);
      transform: rotate(25deg);
      animation: shine 2.8s ease-in-out infinite;
      opacity:.55; pointer-events:none;
    }
    @keyframes shine{0%{transform:translateX(-60%) rotate(25deg)}55%{transform:translateX(10%) rotate(25deg)}100%{transform:translateX(160%) rotate(25deg)}}
    .btxt{min-width:0}
    .btxt h1{margin:0;font-size:18px;letter-spacing:.18em;color:var(--neon);text-shadow:0 0 18px rgba(0,255,160,.35), 0 0 22px rgba(0,212,255,.18);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .btxt p{margin:2px 0 0;color:var(--muted);font-size:12px}

    .pill{
      border:1px solid rgba(0,255,160,.22);
      background:rgba(0,0,0,.18);
      color:var(--text);
      padding:10px 12px;border-radius:14px;
      font-weight:900;letter-spacing:.08em;
      cursor:pointer;
      transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease;
    }
    .pill:hover{border-color:rgba(0,255,160,.38); box-shadow:0 0 26px rgba(0,255,160,.12)}
    .pill:active{transform:translateY(1px)}

    .grid2{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:860px){.grid2{grid-template-columns: 360px 1fr;}}

    .card{
      border:1px solid var(--stroke);
      border-radius:24px;
      background:var(--glass);
      box-shadow:var(--shadow);
      backdrop-filter: blur(16px);
      padding:16px;
      position:relative;
      overflow:hidden;
    }
    .card:before{
      content:""; position:absolute; inset:-2px; pointer-events:none;
      background:
        radial-gradient(circle at 18% 8%, rgba(0,212,255,.16), transparent 45%),
        radial-gradient(circle at 82% 24%, rgba(0,255,160,.14), transparent 42%),
        radial-gradient(circle at 60% 112%, rgba(176,108,255,.10), transparent 55%),
        linear-gradient(180deg, transparent, rgba(0,255,160,.05));
    }

    .title{margin:0;font-weight:1000;letter-spacing:.10em;color:var(--neon)}
    .sub{margin:8px 0 0;color:var(--neon2);font-size:12px;opacity:.9}
    .hr{height:1px;background:rgba(0,255,160,.14);margin:14px 0}

    label{display:block;font-size:12px;color:#9fffdc;margin:0 0 6px 2px;opacity:.95}
    input{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(0,255,160,.22);
      background:rgba(0,0,0,.35);
      color:var(--text);
      outline:none;
      font-size:14px;
    }
    input:focus{border-color:rgba(0,255,160,.75); box-shadow:0 0 0 3px rgba(0,255,160,.12)}

    .btn{
      width:100%;
      margin-top:12px;
      padding:12px 14px;
      border:0;
      border-radius:18px;
      cursor:pointer;
      font-weight:1000;
      letter-spacing:.10em;
      background:linear-gradient(135deg, rgba(0,212,255,.92), rgba(0,255,160,.96), rgba(176,108,255,.72));
      color:#00150b;
      position:relative; overflow:hidden;
      box-shadow: 0 14px 38px rgba(0,255,160,.14);
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .btn:before{
      content:""; position:absolute; inset:-60%;
      background: linear-gradient(120deg, transparent, rgba(255,255,255,.38), transparent);
      transform: rotate(20deg);
      animation: btnshine 3.6s ease-in-out infinite;
      opacity:.45; pointer-events:none;
    }
    @keyframes btnshine{0%{transform:translateX(-70%) rotate(20deg)}55%{transform:translateX(5%) rotate(20deg)}100%{transform:translateX(170%) rotate(20deg)}}

    .msg{margin-top:10px;min-height:18px;font-size:12px;color:#b7ffd9;opacity:.95;white-space:pre-line}
    .err{color:#ff6b84}
    .ok{color:#00ffa0}

    /* Requests list */
    .list{display:flex;flex-direction:column;gap:10px}
    .item{
      border:1px solid rgba(0,255,160,.14);
      border-radius:18px;
      padding:12px;
      background: rgba(0,0,0,.26);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .rowTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start;flex-wrap:wrap}
    .meta b{color:var(--neon);letter-spacing:.06em}
    .meta small{display:block;color:var(--muted);margin-top:4px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .aBtn{
      border:1px solid rgba(0,255,160,.22);
      background:rgba(0,0,0,.18);
      color:var(--neon);
      padding:10px 12px;
      border-radius:14px;
      font-weight:1000;
      cursor:pointer;
    }
    .aBtn.danger{border-color:rgba(255,77,109,.35); color:var(--danger)}
    .badge{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      font-size:11px;
      border:1px solid rgba(0,255,160,.22);
      color:#b7ffd9;
      background: rgba(0,0,0,.20);
    }
    .rightTools{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  </style>
</head>

<body>
  <div class="bgfx">
    <div class="grid"></div>
    <div class="orb orb1"></div>
    <div class="orb orb2"></div>
    <div class="orb orb3"></div>
  </div>
  <div class="scan"></div>

  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo">PG</div>
        <div class="btxt">
          <h1>PHONE GUARD</h1>
          <p>Admin Panel • Approvals</p>
        </div>
      </div>
      <div class="rightTools">
        <span class="badge" id="adminTag">Not logged in</span>
        <button class="pill" id="logoutBtn" type="button" style="display:none;">LOGOUT</button>
      </div>
    </div>

    <div class="grid2">
      <!-- Login -->
      <div class="card" id="loginCard">
        <h3 class="title">ADMIN LOGIN</h3>
        <div class="sub">Only admins can access requests</div>
        <div class="hr"></div>

        <label>Email</label>
        <input id="email" type="email" placeholder="admin@gmail.com" autocomplete="email"/>

        <div style="height:10px"></div>

        <label>Password</label>
        <input id="pass" type="password" placeholder="••••••••" autocomplete="current-password"/>

        <button class="btn" id="loginBtn" type="button">LOGIN</button>
        <div class="msg" id="loginMsg"></div>
      </div>

      <!-- Requests -->
      <div class="card" id="reqCard" style="display:none;">
        <h3 class="title">ACCESS REQUESTS</h3>
        <div class="sub">Pending approvals (real-time)</div>
        <div class="hr"></div>

        <div class="msg" id="reqMsg">Loading…</div>
        <div class="list" id="list"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      collection,
      query,
      where,
      orderBy,
      onSnapshot,
      updateDoc,
      serverTimestamp,
      setDoc
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    // ✅ Use same project config
    const firebaseConfig = {
      apiKey: "AIzaSyBud-tsFoCGWG8S5Qj5cnhImZwGfwn0b5g",
      authDomain: "phone-guard-c2a6c.firebaseapp.com",
      projectId: "phone-guard-c2a6c",
      storageBucket: "phone-guard-c2a6c.firebasestorage.app",
      messagingSenderId: "652581603569",
      appId: "1:652581603569:web:c3912ce05e36ad65bc8150"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const adminTag = document.getElementById("adminTag");
    const logoutBtn = document.getElementById("logoutBtn");

    const loginCard = document.getElementById("loginCard");
    const reqCard = document.getElementById("reqCard");

    const emailEl = document.getElementById("email");
    const passEl = document.getElementById("pass");
    const loginBtn = document.getElementById("loginBtn");
    const loginMsg = document.getElementById("loginMsg");

    const reqMsg = document.getElementById("reqMsg");
    const list = document.getElementById("list");

    let unsubReq = null;
    let adminUser = null;

    const setMsg = (el, text="", cls="")=>{
      el.textContent = text;
      el.className = "msg " + (cls||"");
    };

    async function isAdmin(uid){
      const snap = await getDoc(doc(db, "admins", uid));
      return snap.exists();
    }

    function showAdminUI(email){
      adminTag.textContent = "Admin: " + (email || "OK");
      logoutBtn.style.display = "inline-block";
      loginCard.style.display = "none";
      reqCard.style.display = "block";
    }

    function showLoginUI(){
      adminTag.textContent = "Not logged in";
      logoutBtn.style.display = "none";
      loginCard.style.display = "block";
      reqCard.style.display = "none";
      if(unsubReq){ unsubReq(); unsubReq = null; }
      list.innerHTML = "";
      setMsg(reqMsg, "");
    }

    function fmtTime(ts){
      try{
        const d = ts?.toDate?.();
        if(!d) return "—";
        return d.toLocaleString();
      }catch(_){ return "—"; }
    }

    function renderItem(id, data){
      const email = data.email || "Unknown";
      const userUid = data.userUid || "";
      const service = data.service || "service";
      const created = fmtTime(data.createdAt);

      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="rowTop">
          <div class="meta">
            <b>${email}</b>
            <small>UID: ${userUid}</small>
            <small>Service: ${service}</small>
            <small>Created: ${created}</small>
          </div>
          <div class="actions">
            <button class="aBtn" data-act="approve" data-id="${id}">APPROVE</button>
            <button class="aBtn danger" data-act="reject" data-id="${id}">REJECT</button>
          </div>
        </div>
      `;
      return div;
    }

    async function approveRequest(reqId, data){
      const userUid = data.userUid;
      const email = data.email || "";
      const service = data.service || "device_access";

      // 1) mark request approved
      await updateDoc(doc(db, "accessRequests", reqId), {
        status: "approved",
        approvedAt: serverTimestamp(),
        approvedBy: adminUser?.uid || null
      });

      // 2) persist permission: accessPermissions/{uid}.allowed[service] = true
      // Ensure document exists; merge allowed map
      await setDoc(doc(db, "accessPermissions", userUid), {
        email,
        allowed: { [service]: true },
        updatedAt: serverTimestamp()
      }, { merge:true });

      // Also merge into nested allowed map if already exists (optional extra safety)
      // (setDoc merge above already merges allowed.* by key)
    }

    async function rejectRequest(reqId){
      await updateDoc(doc(db, "accessRequests", reqId), {
        status: "rejected",
        rejectedAt: serverTimestamp(),
        rejectedBy: adminUser?.uid || null
      });
    }

    function listenPending(){
      // pending only
      const q = query(
        collection(db, "accessRequests"),
        where("status", "==", "pending"),
        orderBy("createdAt", "desc")
      );

      unsubReq = onSnapshot(q, (snap)=>{
        list.innerHTML = "";
        if(snap.empty){
          setMsg(reqMsg, "No pending requests ✅", "ok");
          return;
        }
        setMsg(reqMsg, `Pending: ${snap.size}`, "");
        snap.forEach(docu=>{
          const el = renderItem(docu.id, docu.data());
          list.appendChild(el);
        });
      }, (err)=>{
        setMsg(reqMsg, "Error loading requests ❌ (Check rules/index)", "err");
      });
    }

    // Handle approve/reject clicks
    list.addEventListener("click", async (e)=>{
      const btn = e.target.closest("button[data-act]");
      if(!btn) return;
      const act = btn.dataset.act;
      const id = btn.dataset.id;

      btn.disabled = true;
      try{
        // fetch current doc data from DOM snapshot is not stored; simplest: rely on dataset? we need data.
        // We'll find data from UI by reading current snapshot is complex; so we re-read doc once:
        const snap = await getDoc(doc(db, "accessRequests", id));
        if(!snap.exists()){
          btn.disabled = false;
          return;
        }
        const data = snap.data();

        if(act === "approve"){
          await approveRequest(id, data);
        }else{
          await rejectRequest(id);
        }
      }catch(err){
        btn.disabled = false;
        alert("Action failed. Check Firestore rules / internet.");
      }
    });

    // Login
    loginBtn.addEventListener("click", async ()=>{
      const email = (emailEl.value || "").trim().toLowerCase();
      const pass = (passEl.value || "");
      if(!email || !pass){
        setMsg(loginMsg, "Email + Password required", "err");
        return;
      }
      setMsg(loginMsg, "Logging in…", "");
      loginBtn.disabled = true;

      try{
        const cred = await signInWithEmailAndPassword(auth, email, pass);

        const ok = await isAdmin(cred.user.uid);
        if(!ok){
          await signOut(auth);
          setMsg(loginMsg, "Not an admin ❌", "err");
          loginBtn.disabled = false;
          return;
        }

        setMsg(loginMsg, "Admin verified ✅", "ok");
      }catch(e){
        setMsg(loginMsg, "Login failed ❌", "err");
        loginBtn.disabled = false;
      }
    });

    // Logout
    logoutBtn.addEventListener("click", async ()=>{
      await signOut(auth);
      showLoginUI();
    });

    // Auth state
    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        adminUser = null;
        showLoginUI();
        return;
      }

      const ok = await isAdmin(user.uid);
      if(!ok){
        await signOut(auth);
        adminUser = null;
        showLoginUI();
        return;
      }

      adminUser = user;
      showAdminUI(user.email);

      if(unsubReq) unsubReq();
      listenPending();
    });
  </script>
</body>
</html>
